<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯ºè¯ºå°å®ç§¯åˆ†æ¦œ</title>
    <style>
        :root {
            --color-pink: #FFD1DC;
            --color-blue: #B5EAEA;
            --color-green: #C9F4C9;
            --color-yellow: #FFF6BF;
            --color-purple: #E2D1F9;
            --color-orange: #FFD8A7;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Marker Felt', 'æ¥·ä½“', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            background-image: radial-gradient(#ffc8dd 1px, transparent 2px);
            background-size: 30px 30px;
        }

        h1, h2, h3 {
            text-align: center;
            color: #FF6B6B;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #FF6B6B, #FF9E6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 10" width="20" height="10"><path d="M0,5 C5,0 15,10 20,5" stroke="%23FF6B6B" fill="transparent"/></svg>');
            background-size: 20px 10px;
            background-repeat: repeat-x;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background-color: var(--color-pink);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-btn.active {
            background-color: #FF6B6B;
            color: white;
        }

        .page {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 3px solid #FFD6FF;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* å­¦ç”Ÿå¡ç‰‡å¸ƒå±€ */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .student-card {
            background-color: var(--color-blue);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            position: relative;
            transition: transform 0.3s;
            border: 2px dashed #7B68EE;
        }

        .student-card:hover {
            transform: translateY(-5px);
        }

        .student-card h3 {
            margin-top: 0;
            color: #4A47A3;
        }

        .points {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B6B;
            margin: 10px 0;
            text-align: center;
        }

        .student-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .action-btn {
            border: none;
            border-radius: 10px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .add-btn {
            background-color: var(--color-green);
        }

        .subtract-btn {
            background-color: var(--color-yellow);
        }

        .exchange-btn {
            background-color: var(--color-purple);
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç­çº§ç®¡ç†æ“ä½œ */
        .class-management {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--color-orange);
            border-radius: 15px;
            box-shadow: var(--shadow);
            border: 2px solid #FF9E6B;
        }

        .class-actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        /* è‡ªå®šä¹‰è¡Œä¸ºè®¾ç½® */
        .behavior-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .category {
            background-color: var(--color-purple);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 2px solid #9370DB;
        }

        .category h3 {
            color: #7B68EE;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            margin-top: 0;
        }

        .behavior-list {
            list-style-type: none;
            padding: 0;
        }

        .behavior-item {
            background-color: white;
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #7B68EE;
        }

        .behavior-number {
            background-color: #7B68EE;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .behavior-description {
            flex-grow: 1;
            margin-right: 10px;
        }

        .behavior-points {
            font-weight: bold;
            color: #FF6B6B;
            margin-right: 10px;
        }

        /* å…‘æ¢å¥–å“ç®¡ç† */
        .rewards-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .reward-item {
            background-color: var(--color-green);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 2px solid #77DD77;
        }

        .reward-cost {
            font-weight: bold;
            color: #FF6B6B;
        }

        /* ç§¯åˆ†æ—¥å¿— */
        .log-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .log-table th, .log-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .log-table th {
            background-color: var(--color-blue);
            cursor: pointer;
            position: relative;
        }

        .log-table th::after {
            content: "â†•";
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }

        .log-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .log-summary {
            background-color: var(--color-yellow);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* è¡Œä¸ºæœç´¢ */
        .behavior-search-container {
            margin: 10px 0;
            position: relative;
        }

        .behavior-search {
            width: 100%;
            padding: 8px 15px;
            border: 2px solid #B5EAEA;
            border-radius: 20px;
            font-size: 14px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .search-result-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-result-item:hover {
            background-color: #f0f0f0;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid #FFD6FF;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #FFD6FF;
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #FF6B6B;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4A47A3;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #B5EAEA;
            border-radius: 5px;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .students-grid, .behavior-categories, .rewards-list {
                grid-template-columns: 1fr;
            }
            
            .class-actions {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }

        .ribbon {
            background: linear-gradient(45deg, #FF6B6B, #FF9E6B);
            color: white;
            padding: 10px 20px;
            border-radius: 0 15px 15px 0;
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
        }

        .ribbon::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 0;
            border-style: solid;
            border-width: 0 10px 10px 0;
            border-color: transparent #c23b3b transparent transparent;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒˆ è¯ºè¯ºå°å®ç§¯åˆ†æ¦œ ğŸŒˆ</h1>
        
        <!-- å¯¼èˆªæ  -->
        <div class="nav">
            <button class="nav-btn active" data-page="students-management">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç§¯åˆ†ç®¡ç†</button>
            <button class="nav-btn" data-page="behavior-settings">ğŸ“ è‡ªå®šä¹‰è¡Œä¸ºè®¾ç½®</button>
            <button class="nav-btn" data-page="rewards-management">ğŸ å…‘æ¢å¥–å“ç®¡ç†</button>
            <button class="nav-btn" data-page="points-log">ğŸ“Š ç§¯åˆ†æ—¥å¿—</button>
        </div>
        
        <!-- å­¦ç”Ÿç§¯åˆ†ç®¡ç†é¡µé¢ -->
        <div id="students-management" class="page active">
            <div class="ribbon">
                <h2>å­¦ç”Ÿç§¯åˆ†ç®¡ç†</h2>
            </div>
            <div id="students-grid" class="students-grid">
                <!-- å­¦ç”Ÿå¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="class-management">
                <h3>ç­çº§ç®¡ç†æ“ä½œ</h3>
                <div class="class-actions">
                    <button id="add-student-btn" class="action-btn add-btn">â• æ·»åŠ æ–°å­¦ç”Ÿ</button>
                    <button id="add-all-points-btn" class="action-btn add-btn">ğŸ“ˆ å…¨ç­åŠ åˆ†åŠåŸå› </button>
                    <button id="subtract-all-points-btn" class="action-btn subtract-btn">ğŸ“‰ å…¨ç­å‡åˆ†åŠåŸå› </button>
                    <button id="import-data-btn" class="action-btn">ğŸ“¥ æ•°æ®å¯¼å…¥</button>
                    <button id="export-data-btn" class="action-btn">ğŸ“¤ æ•°æ®å¯¼å‡º</button>
                </div>
            </div>
        </div>
        
        <!-- è‡ªå®šä¹‰è¡Œä¸ºè®¾ç½®é¡µé¢ -->
        <div id="behavior-settings" class="page">
            <div class="ribbon">
                <h2>è‡ªå®šä¹‰è¡Œä¸ºè®¾ç½®</h2>
            </div>
            <div class="behavior-categories">
                <!-- è¡Œä¸ºåˆ†ç±»å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="add-behavior-pair-btn" class="action-btn add-btn">â• æ·»åŠ è¡Œä¸ºå¯¹</button>
                <button id="batch-edit-behaviors-btn" class="action-btn">âœï¸ æ‰¹é‡ç¼–è¾‘è¡Œä¸º</button>
            </div>
        </div>
        
        <!-- å…‘æ¢å¥–å“ç®¡ç†é¡µé¢ -->
        <div id="rewards-management" class="page">
            <div class="ribbon">
                <h2>å…‘æ¢å¥–å“ç®¡ç†</h2>
            </div>
            <div id="rewards-list" class="rewards-list">
                <!-- å¥–å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="add-reward-btn" class="action-btn add-btn">â• æ·»åŠ æ–°å¥–å“</button>
            </div>
        </div>
        
        <!-- ç§¯åˆ†æ—¥å¿—é¡µé¢ -->
        <div id="points-log" class="page">
            <div class="ribbon">
                <h2>ç§¯åˆ†æ—¥å¿—</h2>
            </div>
            <div class="log-filters">
                <input type="text" id="log-search" placeholder="ğŸ” æœç´¢...">
                <select id="log-type-filter">
                    <option value="">æ‰€æœ‰ç±»å‹</option>
                    <option value="åŠ åˆ†">åŠ åˆ†</option>
                    <option value="å‡åˆ†">å‡åˆ†</option>
                    <option value="å…‘æ¢">å…‘æ¢</option>
                </select>
                <input type="date" id="log-date-filter">
                <button id="clear-filters-btn" class="action-btn">æ¸…é™¤ç­›é€‰</button>
            </div>
            <table class="log-table">
                <thead>
                    <tr>
                        <th data-sort="timestamp">æ—¶é—´</th>
                        <th data-sort="studentId">å­¦å·</th>
                        <th data-sort="studentName">å§“å</th>
                        <th data-sort="type">ç±»å‹</th>
                        <th data-sort="description">æè¿°</th>
                        <th data-sort="points">ç§¯åˆ†å˜åŒ–</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                    <!-- æ—¥å¿—å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
            <div id="log-summary" class="log-summary">
                <!-- æ—¥å¿—æ±‡æ€»ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">æ¨¡æ€æ¡†æ ‡é¢˜</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="modal-body">
                <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <script>
        // æ•°æ®ç»“æ„å’Œåˆå§‹æ•°æ®
        let data = {
            students: [
                { id: 1, name: "å°æ˜", points: 0 },
                { id: 2, name: "å°çº¢", points: 0 }
            ],
            behaviors: {
                "ç”Ÿæ´»ç¯‡": [
                    { id: 1, description: "å¸®åŠ©åŒå­¦", points: 2 },
                    { id: 2, description: "æ•´ç†æ•™å®¤", points: 3 }
                ],
                "æ ¡å›­ç¯‡": [
                    { id: 1, description: "å‚åŠ æ´»åŠ¨", points: 5 },
                    { id: 2, description: "è¿Ÿåˆ°", points: -2 }
                ],
                "å­¦ä¹ ä¹ æƒ¯ç¯‡": [
                    { id: 1, description: "å®Œæˆä½œä¸š", points: 2 },
                    { id: 2, description: "æœªäº¤ä½œä¸š", points: -3 }
                ],
                "è€ƒè¯•å¥–æƒ©ç¯‡": [
                    { id: 1, description: "è€ƒè¯•ä¼˜ç§€", points: 10 },
                    { id: 2, description: "è€ƒè¯•ä¸åŠæ ¼", points: -5 }
                ]
            },
            rewards: [
                { id: 1, name: "é“…ç¬”", cost: 5 },
                { id: 2, name: "æ©¡çš®", cost: 3 },
                { id: 3, name: "ç¬”è®°æœ¬", cost: 10 }
            ],
            logs: []
        };

        // ä»LocalStorageåŠ è½½æ•°æ®
        function loadData() {
            const savedData = localStorage.getItem('classPointsSystem');
            if (savedData) {
                try {
                    data = JSON.parse(savedData);
                } catch (e) {
                    console.error("è§£æä¿å­˜çš„æ•°æ®æ—¶å‡ºé”™:", e);
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                    localStorage.setItem('classPointsSystem', JSON.stringify(data));
                }
            } else {
                // åˆå§‹åŒ–ä¿å­˜æ•°æ®
                localStorage.setItem('classPointsSystem', JSON.stringify(data));
            }
        }

        // ä¿å­˜æ•°æ®åˆ°LocalStorage
        function saveData() {
            localStorage.setItem('classPointsSystem', JSON.stringify(data));
        }

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            loadData();
            renderStudents();
            renderBehaviorCategories();
            renderRewards();
            renderLogs();
            setupEventListeners();
        }

        // æ¸²æŸ“å­¦ç”Ÿå¡ç‰‡
        function renderStudents() {
            const studentsGrid = document.getElementById('students-grid');
            studentsGrid.innerHTML = '';
            
            data.students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <button class="delete-btn" data-id="${student.id}">&times;</button>
                    <h3 contenteditable="true" onblur="updateStudentName(${student.id}, this.textContent)">${student.name}</h3>
                    <div>å­¦å·: <span contenteditable="true" onblur="updateStudentId(${student.id}, this.textContent)">${student.id}</span></div>
                    <div class="points">${student.points} ç§¯åˆ†</div>
                    <div class="student-actions">
                        <button class="action-btn add-btn" onclick="showAddPointsModal(${student.id})">â• åŠ åˆ†</button>
                        <button class="action-btn subtract-btn" onclick="showSubtractPointsModal(${student.id})">â– å‡åˆ†</button>
                        <button class="action-btn exchange-btn" onclick="showExchangeModal(${student.id})">ğŸ å…‘æ¢</button>
                    </div>
                    <div class="behavior-search-container">
                        <input type="text" class="behavior-search" placeholder="ğŸ” æœç´¢è¡Œä¸º..." 
                               oninput="filterBehaviors(this, ${student.id})">
                        <div class="search-results" id="search-results-${student.id}"></div>
                    </div>
                    <div>
                        <select id="behavior-select-${student.id}" style="width:100%">
                            <option value="">é€‰æ‹©è¡Œä¸º</option>
                        </select>
                        <button class="action-btn" onclick="applyBehavior(${student.id})">åº”ç”¨</button>
                    </div>
                `;
                
                // å¡«å……è¡Œä¸ºé€‰æ‹©ä¸‹æ‹‰æ¡†
                const select = card.querySelector(`#behavior-select-${student.id}`);
                for (const category in data.behaviors) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    
                    data.behaviors[category].forEach(behavior => {
                        const option = document.createElement('option');
                        option.value = `${category}|${behavior.id}`;
                        option.textContent = `${behavior.description} (${behavior.points > 0 ? '+' : ''}${behavior.points})`;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
                
                studentsGrid.appendChild(card);
            });
        }

        // è¿‡æ»¤è¡Œä¸º
        function filterBehaviors(inputElement, studentId) {
            const searchText = inputElement.value.toLowerCase();
            const resultsContainer = document.getElementById(`search-results-${studentId}`);
            resultsContainer.innerHTML = '';
            
            if (searchText.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const results = [];
            
            // æœç´¢æ‰€æœ‰è¡Œä¸º
            for (const category in data.behaviors) {
                data.behaviors[category].forEach(behavior => {
                    if (behavior.description.toLowerCase().includes(searchText)) {
                        results.push({
                            category,
                            behavior,
                            text: `${category}: ${behavior.description} (${behavior.points > 0 ? '+' : ''}${behavior.points})`
                        });
                    }
                });
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            if (results.length > 0) {
                resultsContainer.style.display = 'block';
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = result.text;
                    item.onclick = () => {
                        document.getElementById(`behavior-select-${studentId}`).value = `${result.category}|${result.behavior.id}`;
                        resultsContainer.style.display = 'none';
                        inputElement.value = '';
                        applyBehavior(studentId);
                    };
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        // æ¸²æŸ“è¡Œä¸ºåˆ†ç±»
        function renderBehaviorCategories() {
            const container = document.querySelector('.behavior-categories');
            container.innerHTML = '';
            
            for (const category in data.behaviors) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `<h3>${category}</h3>`;
                
                const list = document.createElement('ul');
                list.className = 'behavior-list';
                
                data.behaviors[category].forEach(behavior => {
                    const item = document.createElement('li');
                    item.className = 'behavior-item';
                    item.innerHTML = `
                        <div class="behavior-number">${behavior.id}</div>
                        <span class="behavior-description" contenteditable="true" onblur="updateBehaviorDescription('${category}', ${behavior.id}, this.textContent)">${behavior.description}</span>
                        <span class="behavior-points" contenteditable="true" onblur="updateBehaviorPoints('${category}', ${behavior.id}, this.textContent)">${behavior.points > 0 ? '+' : ''}${behavior.points}</span>
                        <button class="action-btn subtract-btn" onclick="deleteBehavior('${category}', ${behavior.id})">åˆ é™¤</button>
                    `;
                    list.appendChild(item);
                });
                
                categoryDiv.appendChild(list);
                categoryDiv.innerHTML += `<button class="action-btn add-btn" onclick="showAddBehaviorModal('${category}')">æ·»åŠ è¡Œä¸º</button>`;
                categoryDiv.innerHTML += `<button class="action-btn subtract-btn" onclick="deleteCategoryBehaviors('${category}')">æ‰¹é‡åˆ é™¤</button>`;
                
                container.appendChild(categoryDiv);
            }
        }

        // æ¸²æŸ“å¥–å“åˆ—è¡¨
        function renderRewards() {
            const rewardsList = document.getElementById('rewards-list');
            rewardsList.innerHTML = '';
            
            data.rewards.forEach(reward => {
                const item = document.createElement('div');
                item.className = 'reward-item';
                item.innerHTML = `
                    <h3 contenteditable="true" onblur="updateRewardName(${reward.id}, this.textContent)">${reward.name}</h3>
                    <div class="reward-cost" contenteditable="true" onblur="updateRewardCost(${reward.id}, this.textContent)">${reward.cost} ç§¯åˆ†</div>
                    <button class="action-btn subtract-btn" onclick="deleteReward(${reward.id})">åˆ é™¤</button>
                `;
                rewardsList.appendChild(item);
            });
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs() {
            const logTableBody = document.getElementById('log-table-body');
            logTableBody.innerHTML = '';
            
            // åº”ç”¨ç­›é€‰
            const searchText = document.getElementById('log-search').value.toLowerCase();
            const typeFilter = document.getElementById('log-type-filter').value;
            const dateFilter = document.getElementById('log-date-filter').value;
            
            let filteredLogs = data.logs.filter(log => {
                const matchesSearch = log.studentName.toLowerCase().includes(searchText) || 
                                     log.description.toLowerCase().includes(searchText);
                const matchesType = !typeFilter || log.type === typeFilter;
                const matchesDate = !dateFilter || log.timestamp.startsWith(dateFilter);
                
                return matchesSearch && matchesType && matchesDate;
            });
            
            // æ’åº (ç®€åŒ–å®ç°)
            const sortBy = document.querySelector('.log-table th[data-sort].sorted')?.dataset.sort || 'timestamp';
            filteredLogs.sort((a, b) => {
                if (a[sortBy] < b[sortBy]) return -1;
                if (a[sortBy] > b[sortBy]) return 1;
                return 0;
            });
            
            // è®¡ç®—æ±‡æ€»
            let addPointsTotal = 0;
            let subtractPointsTotal = 0;
            let exchangePointsTotal = 0;
            
            // æ¸²æŸ“æ—¥å¿—è¡Œ
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td>${log.studentId}</td>
                    <td>${log.studentName}</td>
                    <td>${log.type}</td>
                    <td>${log.description}</td>
                    <td>${log.points > 0 ? '+' : ''}${log.points}</td>
                    <td><button class="action-btn subtract-btn" onclick="deleteLog('${log.timestamp}', ${log.studentId}, ${log.points}, '${log.type}')">åˆ é™¤</button></td>
                `;
                logTableBody.appendChild(row);
                
                // è®¡ç®—æ±‡æ€»
                if (log.type === 'åŠ åˆ†') {
                    addPointsTotal += log.points;
                } else if (log.type === 'å‡åˆ†') {
                    subtractPointsTotal += Math.abs(log.points);
                } else if (log.type === 'å…‘æ¢') {
                    exchangePointsTotal += Math.abs(log.points);
                }
            });
            
            // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
            const logSummary = document.getElementById('log-summary');
            logSummary.innerHTML = `
                <div>åŠ åˆ†æ€»è®¡: ${addPointsTotal} | å‡åˆ†æ€»è®¡: ${subtractPointsTotal} | å…‘æ¢æ€»è®¡: ${exchangePointsTotal}</div>
            `;
        }

        // åˆ é™¤æ—¥å¿—è®°å½•
        function deleteLog(timestamp, studentId, points, type) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œå°†å½±å“å­¦ç”Ÿçš„ç§¯åˆ†ï¼')) {
                return;
            }
            
            // æ‰¾åˆ°è¦åˆ é™¤çš„æ—¥å¿—ç´¢å¼•
            const logIndex = data.logs.findIndex(log => 
                log.timestamp === timestamp && log.studentId === studentId && log.points === points && log.type === type
            );
            
            if (logIndex === -1) {
                alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®°å½•');
                return;
            }
            
            // æ›´æ–°å­¦ç”Ÿç§¯åˆ†
            const student = data.students.find(s => s.id === studentId);
            if (student) {
                if (type === 'åŠ åˆ†') {
                    student.points = Math.max(0, student.points - points);
                } else if (type === 'å‡åˆ†') {
                    student.points += Math.abs(points);
                } else if (type === 'å…‘æ¢') {
                    student.points += Math.abs(points);
                }
            }
            
            // åˆ é™¤æ—¥å¿—
            data.logs.splice(logIndex, 1);
            
            saveData();
            renderStudents();
            renderLogs();
            alert('è®°å½•å·²åˆ é™¤ï¼Œå­¦ç”Ÿç§¯åˆ†å·²è°ƒæ•´');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å¯¼èˆªæŒ‰é’®
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.page).classList.add('active');
                });
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.close-btn').addEventListener('click', hideModal);
            
            // æ·»åŠ å­¦ç”Ÿ
            document.getElementById('add-student-btn').addEventListener('click', showAddStudentModal);
            
            // å…¨ç­åŠ å‡åˆ†
            document.getElementById('add-all-points-btn').addEventListener('click', () => showBatchPointsModal(true));
            document.getElementById('subtract-all-points-btn').addEventListener('click', () => showBatchPointsModal(false));
            
            // æ•°æ®å¯¼å…¥å¯¼å‡º
            document.getElementById('import-data-btn').addEventListener('click', importData);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            
            // æ·»åŠ è¡Œä¸ºå¯¹
            document.getElementById('add-behavior-pair-btn').addEventListener('click', showAddBehaviorPairModal);
            
            // æ‰¹é‡ç¼–è¾‘è¡Œä¸º
            document.getElementById('batch-edit-behaviors-btn').addEventListener('click', showBatchEditBehaviorsModal);
            
            // æ·»åŠ å¥–å“
            document.getElementById('add-reward-btn').addEventListener('click', showAddRewardModal);
            
            // æ—¥å¿—ç­›é€‰
            document.getElementById('log-search').addEventListener('input', renderLogs);
            document.getElementById('log-type-filter').addEventListener('change', renderLogs);
            document.getElementById('log-date-filter').addEventListener('change', renderLogs);
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('log-search').value = '';
                document.getElementById('log-type-filter').value = '';
                document.getElementById('log-date-filter').value = '';
                renderLogs();
            });
            
            // æ—¥å¿—è¡¨å¤´æ’åº
            document.querySelectorAll('.log-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    document.querySelectorAll('.log-table th[data-sort]').forEach(h => h.classList.remove('sorted'));
                    th.classList.add('sorted');
                    renderLogs();
                });
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) {
                    hideModal();
                }
            });
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // æ˜¾ç¤ºæ·»åŠ å­¦ç”Ÿæ¨¡æ€æ¡†
        function showAddStudentModal() {
            const content = `
                <div class="form-group">
                    <label for="new-student-name">å§“å:</label>
                    <input type="text" id="new-student-name" required>
                </div>
                <div class="form-group">
                    <label for="new-student-id">å­¦å·:</label>
                    <input type="number" id="new-student-id" value="${data.students.length > 0 ? Math.max(...data.students.map(s => s.id)) + 1 : 1}" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="addStudent()">æ·»åŠ </button>
                </div>
            `;
            showModal('æ·»åŠ æ–°å­¦ç”Ÿ', content);
        }

        // æ·»åŠ å­¦ç”Ÿ
        function addStudent() {
            const name = document.getElementById('new-student-name').value;
            const id = parseInt(document.getElementById('new-student-id').value);
            
            if (!name || isNaN(id)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å§“åå’Œå­¦å·');
                return;
            }
            
            if (data.students.some(s => s.id === id)) {
                alert('è¯¥å­¦å·å·²å­˜åœ¨');
                return;
            }
            
            data.students.push({ id, name, points: 0 });
            saveData();
            renderStudents();
            hideModal();
        }

        // æ›´æ–°å­¦ç”Ÿå§“å
        function updateStudentName(studentId, newName) {
            const student = data.students.find(s => s.id === studentId);
            if (student && newName.trim()) {
                student.name = newName.trim();
                saveData();
            } else {
                renderStudents(); // æ¢å¤åŸå€¼
            }
        }

        // æ›´æ–°å­¦ç”Ÿå­¦å·
        function updateStudentId(oldId, newId) {
            const newIdNum = parseInt(newId);
            if (isNaN(newIdNum) || newIdNum < 1) {
                alert('å­¦å·å¿…é¡»æ˜¯æ­£æ•´æ•°');
                renderStudents();
                return;
            }
            
            if (data.students.some(s => s.id === newIdNum && s.id !== oldId)) {
                alert('è¯¥å­¦å·å·²å­˜åœ¨');
                renderStudents();
                return;
            }
            
            const student = data.students.find(s => s.id === oldId);
            if (student) {
                // æ›´æ–°æ—¥å¿—ä¸­çš„å­¦å·
                data.logs.forEach(log => {
                    if (log.studentId === oldId) {
                        log.studentId = newIdNum;
                    }
                });
                
                student.id = newIdNum;
                saveData();
            }
        }

        // åˆ é™¤å­¦ç”Ÿ
        function deleteStudent(studentId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ç”Ÿå—ï¼Ÿ')) {
                data.students = data.students.filter(s => s.id !== studentId);
                // åŒæ—¶åˆ é™¤ç›¸å…³æ—¥å¿—
                data.logs = data.logs.filter(log => log.studentId !== studentId);
                saveData();
                renderStudents();
                renderLogs();
            }
        }

        // æ˜¾ç¤ºåŠ åˆ†æ¨¡æ€æ¡†
        function showAddPointsModal(studentId) {
            const content = `
                <div class="form-group">
                    <label for="points-to-add">åŠ åˆ†æ•°é‡:</label>
                    <input type="number" id="points-to-add" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="add-reason">åŸå› :</label>
                    <input type="text" id="add-reason" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="addPoints(${studentId})">ç¡®å®š</button>
                </div>
            `;
            showModal('ä¸ºå­¦ç”ŸåŠ åˆ†', content);
        }

        // åŠ åˆ†
        function addPoints(studentId) {
            const points = parseInt(document.getElementById('points-to-add').value);
            const reason = document.getElementById('add-reason').value;
            
            if (isNaN(points) || points < 1 || !reason) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°å’ŒåŸå› ');
                return;
            }
            
            const student = data.students.find(s => s.id === studentId);
            if (student) {
                student.points += points;
                
                // è®°å½•æ—¥å¿—
                data.logs.push({
                    timestamp: new Date().toLocaleString(),
                    studentId: student.id,
                    studentName: student.name,
                    type: 'åŠ åˆ†',
                    description: reason,
                    points: points
                });
                
                saveData();
                renderStudents();
                renderLogs();
                hideModal();
            }
        }

        // æ˜¾ç¤ºå‡åˆ†æ¨¡æ€æ¡†
        function showSubtractPointsModal(studentId) {
            const content = `
                <div class="form-group">
                    <label for="points-to-subtract">å‡åˆ†æ•°é‡:</label>
                    <input type="number" id="points-to-subtract" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="subtract-reason">åŸå› :</label>
                    <input type="text" id="subtract-reason" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn subtract-btn" onclick="subtractPoints(${studentId})">ç¡®å®š</button>
                </div>
            `;
            showModal('ä¸ºå­¦ç”Ÿå‡åˆ†', content);
        }

        // å‡åˆ†
        function subtractPoints(studentId) {
            const points = parseInt(document.getElementById('points-to-subtract').value);
            const reason = document.getElementById('subtract-reason').value;
            
            if (isNaN(points) || points < 1 || !reason) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°å’ŒåŸå› ');
                return;
            }
            
            const student = data.students.find(s => s.id === studentId);
            if (student) {
                student.points = Math.max(0, student.points - points);
                
                // è®°å½•æ—¥å¿—
                data.logs.push({
                    timestamp: new Date().toLocaleString(),
                    studentId: student.id,
                    studentName: student.name,
                    type: 'å‡åˆ†',
                    description: reason,
                    points: -points
                });
                
                saveData();
                renderStudents();
                renderLogs();
                hideModal();
            }
        }

        // æ˜¾ç¤ºå…‘æ¢æ¨¡æ€æ¡†
        function showExchangeModal(studentId) {
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            let options = '';
            data.rewards.forEach(reward => {
                if (student.points >= reward.cost) {
                    options += `<option value="${reward.id}">${reward.name} (${reward.cost}ç§¯åˆ†)</option>`;
                }
            });
            
            if (!options) {
                alert('æ²¡æœ‰å¯å…‘æ¢çš„å¥–å“æˆ–ç§¯åˆ†ä¸è¶³');
                return;
            }
            
            const content = `
                <div class="form-group">
                    <label for="reward-to-exchange">é€‰æ‹©å¥–å“:</label>
                    <select id="reward-to-exchange" required>
                        ${options}
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn exchange-btn" onclick="exchangeReward(${studentId})">å…‘æ¢</button>
                </div>
            `;
            showModal('å…‘æ¢å¥–å“', content);
        }

        // å…‘æ¢å¥–å“
        function exchangeReward(studentId) {
            const rewardId = parseInt(document.getElementById('reward-to-exchange').value);
            const reward = data.rewards.find(r => r.id === rewardId);
            const student = data.students.find(s => s.id === studentId);
            
            if (!reward || !student) return;
            
            if (student.points < reward.cost) {
                alert('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢');
                return;
            }
            
            student.points -= reward.cost;
            
            // è®°å½•æ—¥å¿—
            data.logs.push({
                timestamp: new Date().toLocaleString(),
                studentId: student.id,
                studentName: student.name,
                type: 'å…‘æ¢',
                description: `å…‘æ¢äº†${reward.name}`,
                points: -reward.cost
            });
            
            saveData();
            renderStudents();
            renderLogs();
            hideModal();
        }

        // åº”ç”¨è¡Œä¸º
        function applyBehavior(studentId) {
            const select = document.getElementById(`behavior-select-${studentId}`);
            const value = select.value;
            
            if (!value) return;
            
            const [category, behaviorId] = value.split('|');
            const behavior = data.behaviors[category].find(b => b.id === parseInt(behaviorId));
            const student = data.students.find(s => s.id === studentId);
            
            if (!behavior || !student) return;
            
            student.points = Math.max(0, student.points + behavior.points);
            
            // è®°å½•æ—¥å¿—
            data.logs.push({
                timestamp: new Date().toLocaleString(),
                studentId: student.id,
                studentName: student.name,
                type: behavior.points > 0 ? 'åŠ åˆ†' : 'å‡åˆ†',
                description: behavior.description,
                points: behavior.points
            });
            
            saveData();
            renderStudents();
            renderLogs();
            
            // é‡ç½®é€‰æ‹©
            select.value = '';
        }

        // æ˜¾ç¤ºå…¨ç­åŠ å‡åˆ†æ¨¡æ€æ¡†
        function showBatchPointsModal(isAdd) {
            const content = `
                <div class="form-group">
                    <label for="batch-points">${isAdd ? 'åŠ åˆ†' : 'å‡åˆ†'}æ•°é‡:</label>
                    <input type="number" id="batch-points" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="batch-reason">åŸå› :</label>
                    <input type="text" id="batch-reason" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn ${isAdd ? 'add-btn' : 'subtract-btn'}" onclick="batchPoints(${isAdd})">ç¡®å®š</button>
                </div>
            `;
            showModal(isAdd ? 'å…¨ç­åŠ åˆ†' : 'å…¨ç­å‡åˆ†', content);
        }

        // å…¨ç­åŠ å‡åˆ†
        function batchPoints(isAdd) {
            const points = parseInt(document.getElementById('batch-points').value);
            const reason = document.getElementById('batch-reason').value;
            
            if (isNaN(points) || points < 1 || !reason) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°å’ŒåŸå› ');
                return;
            }
            
            const pointsChange = isAdd ? points : -points;
            
            data.students.forEach(student => {
                student.points = Math.max(0, student.points + pointsChange);
                
                // è®°å½•æ—¥å¿—
                data.logs.push({
                    timestamp: new Date().toLocaleString(),
                    studentId: student.id,
                    studentName: student.name,
                    type: isAdd ? 'åŠ åˆ†' : 'å‡åˆ†',
                    description: `å…¨ç­${reason}`,
                    points: pointsChange
                });
            });
            
            saveData();
            renderStudents();
            renderLogs();
            hideModal();
        }

        // æ˜¾ç¤ºæ·»åŠ è¡Œä¸ºæ¨¡æ€æ¡†
        function showAddBehaviorModal(category) {
            const content = `
                <div class="form-group">
                    <label for="new-behavior-desc">è¡Œä¸ºæè¿°:</label>
                    <input type="text" id="new-behavior-desc" required>
                </div>
                <div class="form-group">
                    <label for="new-behavior-points">ç§¯åˆ†å˜åŒ–:</label>
                    <input type="number" id="new-behavior-points" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="addBehavior('${category}')">æ·»åŠ </button>
                </div>
            `;
            showModal(`æ·»åŠ è¡Œä¸ºåˆ°${category}`, content);
        }

        // æ·»åŠ è¡Œä¸º
        function addBehavior(category) {
            const description = document.getElementById('new-behavior-desc').value;
            const points = parseInt(document.getElementById('new-behavior-points').value);
            
            if (!description || isNaN(points)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æè¿°å’Œåˆ†æ•°');
                return;
            }
            
            // ç”Ÿæˆæ–°ID
            const newId = data.behaviors[category].length > 0 ? 
                Math.max(...data.behaviors[category].map(b => b.id)) + 1 : 1;
            
            data.behaviors[category].push({ id: newId, description, points });
            saveData();
            renderBehaviorCategories();
            hideModal();
        }

        // æ›´æ–°è¡Œä¸ºæè¿°
        function updateBehaviorDescription(category, behaviorId, newDescription) {
            const behavior = data.behaviors[category].find(b => b.id === behaviorId);
            if (behavior && newDescription.trim()) {
                behavior.description = newDescription.trim();
                saveData();
            } else {
                renderBehaviorCategories(); // æ¢å¤åŸå€¼
            }
        }

        // æ›´æ–°è¡Œä¸ºç§¯åˆ†
        function updateBehaviorPoints(category, behaviorId, newPoints) {
            const points = parseInt(newPoints);
            if (isNaN(points)) {
                alert('ç§¯åˆ†å¿…é¡»æ˜¯æ•°å­—');
                renderBehaviorCategories();
                return;
            }
            
            const behavior = data.behaviors[category].find(b => b.id === behaviorId);
            if (behavior) {
                behavior.points = points;
                saveData();
            }
        }

        // åˆ é™¤è¡Œä¸º
        function deleteBehavior(category, behaviorId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡Œä¸ºå—ï¼Ÿ')) {
                data.behaviors[category] = data.behaviors[category].filter(b => b.id !== behaviorId);
                // é‡æ–°æ’åºè¡Œä¸ºID
                reorderBehaviorIds(category);
                saveData();
                renderBehaviorCategories();
            }
        }

        // é‡æ–°æ’åºè¡Œä¸ºID
        function reorderBehaviorIds(category) {
            data.behaviors[category].forEach((behavior, index) => {
                behavior.id = index + 1;
            });
        }

        // åˆ é™¤æ•´ä¸ªåˆ†ç±»çš„è¡Œä¸º
        function deleteCategoryBehaviors(category) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤${category}çš„æ‰€æœ‰è¡Œä¸ºå—ï¼Ÿ`)) {
                data.behaviors[category] = [];
                saveData();
                renderBehaviorCategories();
            }
        }

        // æ˜¾ç¤ºæ·»åŠ è¡Œä¸ºå¯¹æ¨¡æ€æ¡†
        function showAddBehaviorPairModal() {
            const content = `
                <div class="form-group">
                    <label for="behavior-pair-category">é€‰æ‹©åˆ†ç±»:</label>
                    <select id="behavior-pair-category">
                        ${Object.keys(data.behaviors).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="positive-behavior">æ­£å‘è¡Œä¸ºæè¿°:</label>
                    <input type="text" id="positive-behavior" required>
                </div>
                <div class="form-group">
                    <label for="positive-points">æ­£å‘ç§¯åˆ†:</label>
                    <input type="number" id="positive-points" min="1" value="2" required>
                </div>
                <div class="form-group">
                    <label for="negative-behavior">è´Ÿå‘è¡Œä¸ºæè¿°:</label>
                    <input type="text" id="negative-behavior" required>
                </div>
                <div class="form-group">
                    <label for="negative-points">è´Ÿå‘ç§¯åˆ†:</label>
                    <input type="number" id="negative-points" max="-1" value="-2" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="addBehaviorPair()">æ·»åŠ </button>
                </div>
            `;
            showModal('æ·»åŠ è¡Œä¸ºå¯¹', content);
        }

        // æ·»åŠ è¡Œä¸ºå¯¹
        function addBehaviorPair() {
            const category = document.getElementById('behavior-pair-category').value;
            const positiveDesc = document.getElementById('positive-behavior').value;
            const positivePoints = parseInt(document.getElementById('positive-points').value);
            const negativeDesc = document.getElementById('negative-behavior').value;
            const negativePoints = parseInt(document.getElementById('negative-points').value);
            
            if (!positiveDesc || !negativeDesc || isNaN(positivePoints) || isNaN(negativePoints) || positivePoints < 1 || negativePoints > -1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æè¿°å’Œåˆ†æ•°ï¼ˆæ­£å‘åˆ†æ•°å¿…é¡»ä¸ºæ­£ï¼Œè´Ÿå‘åˆ†æ•°å¿…é¡»ä¸ºè´Ÿï¼‰');
                return;
            }
            
            // ç”Ÿæˆæ–°ID
            const maxId = data.behaviors[category].length > 0 ? 
                Math.max(...data.behaviors[category].map(b => b.id)) : 0;
            
            data.behaviors[category].push(
                { id: maxId + 1, description: positiveDesc, points: positivePoints },
                { id: maxId + 2, description: negativeDesc, points: negativePoints }
            );
            
            saveData();
            renderBehaviorCategories();
            hideModal();
        }

        // æ˜¾ç¤ºæ‰¹é‡ç¼–è¾‘è¡Œä¸ºæ¨¡æ€æ¡†
        function showBatchEditBehaviorsModal() {
            let content = `
                <div class="form-group">
                    <label for="batch-edit-category">é€‰æ‹©åˆ†ç±»:</label>
                    <select id="batch-edit-category">
                        ${Object.keys(data.behaviors).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‰¹é‡ç¼–è¾‘è¡Œä¸º (æ¯è¡Œä¸€ä¸ªè¡Œä¸ºï¼Œæ ¼å¼: æè¿°,åˆ†æ•°):</label>
                    <textarea id="batch-behaviors" rows="10" style="width: 100%;"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="applyBatchEditBehaviors()">åº”ç”¨</button>
                </div>
            `;
            showModal('æ‰¹é‡ç¼–è¾‘è¡Œä¸º', content);
        }

        // åº”ç”¨æ‰¹é‡ç¼–è¾‘è¡Œä¸º
        function applyBatchEditBehaviors() {
            const category = document.getElementById('batch-edit-category').value;
            const text = document.getElementById('batch-behaviors').value;
            
            if (!text.trim()) {
                alert('è¯·è¾“å…¥è¡Œä¸ºæ•°æ®');
                return;
            }
            
            const lines = text.split('\n');
            const newBehaviors = [];
            let nextId = 1;
            
            for (const line of lines) {
                const [desc, pointsStr] = line.split(',');
                if (!desc || !pointsStr) continue;
                
                const points = parseInt(pointsStr);
                if (isNaN(points)) continue;
                
                newBehaviors.push({ id: nextId++, description: desc.trim(), points });
            }
            
            if (newBehaviors.length === 0) {
                alert('æ²¡æœ‰æœ‰æ•ˆçš„è¡Œæ•°æ®');
                return;
            }
            
            data.behaviors[category] = newBehaviors;
            saveData();
            renderBehaviorCategories();
            hideModal();
        }

        // æ˜¾ç¤ºæ·»åŠ å¥–å“æ¨¡æ€æ¡†
        function showAddRewardModal() {
            const content = `
                <div class="form-group">
                    <label for="new-reward-name">å¥–å“åç§°:</label>
                    <input type="text" id="new-reward-name" required>
                </div>
                <div class="form-group">
                    <label for="new-reward-cost">æ‰€éœ€ç§¯åˆ†:</label>
                    <input type="number" id="new-reward-cost" min="1" value="5" required>
                </div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="hideModal()">å–æ¶ˆ</button>
                    <button class="action-btn add-btn" onclick="addReward()">æ·»åŠ </button>
                </div>
            `;
            showModal('æ·»åŠ æ–°å¥–å“', content);
        }

        // æ·»åŠ å¥–å“
        function addReward() {
            const name = document.getElementById('new-reward-name').value;
            const cost = parseInt(document.getElementById('new-reward-cost').value);
            
            if (!name || isNaN(cost) || cost < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åç§°å’Œç§¯åˆ†æˆæœ¬');
                return;
            }
            
            // ç”Ÿæˆæ–°ID
            const newId = data.rewards.length > 0 ? 
                Math.max(...data.rewards.map(r => r.id)) + 1 : 1;
            
            data.rewards.push({ id: newId, name, cost });
            saveData();
            renderRewards();
            hideModal();
        }

        // æ›´æ–°å¥–å“åç§°
        function updateRewardName(rewardId, newName) {
            const reward = data.rewards.find(r => r.id === rewardId);
            if (reward && newName.trim()) {
                reward.name = newName.trim();
                saveData();
            } else {
                renderRewards(); // æ¢å¤åŸå€¼
            }
        }

        // æ›´æ–°å¥–å“æˆæœ¬
        function updateRewardCost(rewardId, newCost) {
            const cost = parseInt(newCost);
            if (isNaN(cost) || cost < 1) {
                alert('æˆæœ¬å¿…é¡»æ˜¯æ­£æ•´æ•°');
                renderRewards();
                return;
            }
            
            const reward = data.rewards.find(r => r.id === rewardId);
            if (reward) {
                reward.cost = cost;
                saveData();
            }
        }

        // åˆ é™¤å¥–å“
        function deleteReward(rewardId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥–å“å—ï¼Ÿ')) {
                data.rewards = data.rewards.filter(r => r.id !== rewardId);
                saveData();
                renderRewards();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            // è·å–å½“å‰æ—¶é—´
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const filename = `ç§¯åˆ†æ¦œæ•°æ®_${year}-${month}-${day}_${hours}-${minutes}-${seconds}.xls`;
            
            // åˆ›å»ºè¡¨æ ¼å†…å®¹
            let tableContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <!--[if gte mso 9]>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>å­¦ç”Ÿç§¯åˆ†</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <![endif]-->
                </head>
                <body>
                    <table>
                        <tr>
                            <th>å­¦å·</th>
                            <th>å§“å</th>
                            <th>ç§¯åˆ†</th>
                            <th>ç§¯åˆ†æ˜ç»†</th>
                        </tr>
            `;
            
            // æ·»åŠ å­¦ç”Ÿæ•°æ®
            data.students.forEach(student => {
                // è·å–è¯¥å­¦ç”Ÿçš„æ‰€æœ‰æ—¥å¿—
                const studentLogs = data.logs.filter(log => log.studentId === student.id);
                let details = '';
                
                studentLogs.forEach(log => {
                    details += `${log.timestamp} [${log.type}] ${log.description}: ${log.points > 0 ? '+' : ''}${log.points}\\n`;
                });
                
                tableContent += `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.points}</td>
                        <td>${details}</td>
                    </tr>
                `;
            });
            
            tableContent += `
                    </table>
                </body>
                </html>
            `;
            
            // åˆ›å»ºBlobå’Œä¸‹è½½é“¾æ¥
            const blob = new Blob([tableContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xls,.xlsx,.csv';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    // ç®€å•æç¤ºï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦è§£æExcelæ–‡ä»¶
                    alert('Excelå¯¼å…¥åŠŸèƒ½éœ€è¦æ›´å¤æ‚çš„å®ç°ã€‚å»ºè®®ä½¿ç”¨ç³»ç»Ÿå†…çš„æ•°æ®ç®¡ç†åŠŸèƒ½ã€‚');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // åˆå§‹åŒ–
        window.onload = init;

        // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶å§”æ‰˜
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-btn') && e.target.dataset.id) {
                deleteStudent(parseInt(e.target.dataset.id));
            }
        });

        // ç‚¹å‡»æœç´¢åŒºåŸŸå¤–éƒ¨æ—¶éšè—æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('behavior-search')) {
                document.querySelectorAll('.search-results').forEach(container => {
                    container.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>